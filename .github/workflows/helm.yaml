name: Helm

on:
  push:
    branches: ["**"]
    tags: ["v*"]
    paths:
      - "deploy/**"
      - ".github/workflows/helm.yaml"
  pull_request:
    branches: [main]
    paths:
      - "deploy/**"
      - ".github/workflows/helm.yaml"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Lint chart
        run: helm lint deploy/

  package-push:
    name: Package & Push
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Determine chart version
        id: version
        run: |
          BASE=$(grep '^version:' deploy/Chart.yaml | awk '{print $2}')
          SHA=$(git rev-parse --short HEAD)
          # Sanitize branch name: replace / and _ with -
          BRANCH=$(echo "${GITHUB_REF_NAME}" | sed 's/[/_]/-/g')

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF_NAME#v}" >> "${GITHUB_OUTPUT}"
          else
            echo "version=${BASE}-${BRANCH}-${SHA}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Package chart
        run: |
          helm package deploy/ \
            --version "${{ steps.version.outputs.version }}" \
            --app-version "${{ steps.version.outputs.version }}"

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push chart to GHCR
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          helm registry login ghcr.io \
            --username "${{ github.actor }}" \
            --password "${{ secrets.GITHUB_TOKEN }}"
          helm push "harbor-router-${{ steps.version.outputs.version }}.tgz" \
            oci://ghcr.io/${OWNER}/charts
